# k8s 헬름차트란?

보통 쿠버네티스를 사용하면 단일 클러스터 환경에서 운영하지 않습니다. 보통 `phase`의 클러스터는 하나 이상의 노드를 갖는 클러스터 형태인 경우가 대부분입니다. 또한 쿠버네티스를 사용하면 디플로이먼트, 서비스, 인그레스, 컨피그맵, 시크릿 등 여러 종류의 리소스들을 조합하는 형태로 배포하게 됩니다. 

하지만 각 `phase`마다 달라지는 정보들이 많아지면 모든 환경마다 manifest를 작성해야하는지 고민하게 됩니다. 관리 역시 쉽지 않을겁니다. 이렇게 배포 환경에 따라 달라지는 설정값만 정의해 둔 다음 이에 따라 배포하는 메커니즘이 필요하게 되었는데, 이를 해결한 것이 `헬름(Helm)` 입니다.

## 1. 패키지 매니저란?

헬름은 쿠버네티스 패키지를 손 쉽게 배포할 수 있도록 패키지를 관리하는 쿠버네티스 전용 패키지 매니저입니다. 패키지 매니저는 다양한 목적으로 사용되지만, 가장 중요한 목적은 설치에 필요한 의존성 파일들을 관리하고 간편하게 설치할 수 있도록 도와주는 것 입니다. 

패키지 매니저의 역할은 아래와 같습니다.

- 패키지 검색: 설정한 저장소에서 패키지를 검색하는 기능을 제공합니다. 저장소는 목적에 따라 변경이 가능합니다.

- 패키지 관리: 저장소에서 패키지 정보를 확인하고, 사용자 시스템에 패키지 설치, 삭제, 업그레이드, 원복등을 할 수 있습니다.

- 패키지 의존서 관리: 패키지를 설치할 때 의존하는 소프트웨어를 같이 설치하고, 삭제할 때 같이 삭제할 수 있습니다.

- 패키지 보안 관리: 디지털 인증서와 패키지에 고유하게 발행되는 체크섬이라는 값으로 해당 패키지의 소프트웨어나 의존성이 변조됐는지 검사할 수 있습니다.

보통 실무에서는 로컬 및 운영 클러스터를 포함해서 여러 환경에 배포해야 하는 애플리케이션은 모두 차트로 패키징해 `kubectl` 대신 `헬름`으로 배포 및 업데이트를 수행합니다. 그리고 만약 수정이 필요하면 그때는 `kubectl`로 수정합니다.


## 2. 차트란(chart)?

`차트`는 위에서 설명한 것처럼 각 `phase`별로 쿠버네티스 리소스들을 패키징한 것을 말합니다. 

차트는 헬름 저장소에 공개해 여러 사용자가 공유할 수 있습니다. 각 사용자는 공개된 저장소에 등록된 차트를 이용하여 애플리케이션을 원하는 형태로 쿠버네티스에 배포할 수 있습니다.

헬름 기본 저장소는 `아티팩트허브(artifacthub.io)`로, 다른 패키지 매니지처럼 외부에 있습니다. 
다른 저장소와 다르게 아티팩트 허브에서는 설치할 패키지에 대한 경로만 제공합니다. 

### 2.1 차트 내부 구성도

```chart
jenkins
├── Chart.yaml
├── templates
│   ├── _helpers.tpl
│   ├── configmap.yaml
│   ├── deployment.yaml
│   ├── fluentd-configmap.yaml
│   ├── fluentd-file-configmap.yaml
│   ├── hpa.yaml
│   ├── pdb.yaml
│   ├── secret.yaml
│   ├── service.yaml
│   └── virtualservice.yaml
└── values.yaml
```

위 파일들 중에서 중요한 파일들에 대해서만 간단하게 살펴봤습니다.

- Chart.yaml: 차트의 정보가 정의된 파일
- values.yaml: 차트 기본값 value 파일
- _helpers.tpl: manifest 렌더링에 사용되는 템플릿 헬퍼


## 3. 헬름 차트 설치 명령어 

사용자는 설치하려는 애플리케이션의 차트 저장소 주소를 아티팩트허브에서 얻으면 헬름을 통해서 주소를 등록할 수 있습니다.

그리고 이를 최신으로 업데이트한 이후에 차트를 내려받고 설치합니다.  이렇게 헬름을 통해서 쿠버네티스에 설치된 애플리케이션 패키지를 `릴리즈`라고 합니다. 

헬름으로 차트를 관리하는 저장소를 등록하는 명령어는 아래와 같습니다.

```bash
helm repo add edu https://iac-source.github.io/helm-charts
```

책에서는 `edu`로 저장소의 이름을 등록해서 동일하게 저도 등록하였습니다.
그리고 아래와 같이 저장소가 정상적으로 잘 등록 되었는지 확인이 가능합니다. 

```bash
helm repo list # 저장소 목록 확인
```

> 참고로 helm repo update 명령어를 수행하면 차트가 변경되는 경우 변경된 정보를 로컬 캐시에 업데이트 할 수 있습니다. 이것은 관습적으로 이루어지기 때문에 습관을 들이는게 좋습니다.

헬름 차트를 설치할 때 사용하는 명령어는 `helm install`이며 인자를 바로 명령줄에서 받아서 처리할 수 있습니다. 

- --namespace: 헬름 차트를 통해서 생성되는 애플리케이션이 위치할 네임스페이스를 지정합니다. 

- --create-namespace: 네임스페이스 옵션으로 지정된 네임스페이스가 존재하지 않는 경우 네임스페이스를 생성합니다.

- --set: 헬름에서 사용할 변수를 명령 인자로 전달합니다. key1=value1, key2=value2와 같이 ,(쉼표)를 사용해 한 줄에서 여러 인자를 넘겨 줄 수 있습니다.

```bash
helm install metallb edu/metallb \
--namespace=metallb-system \
--create-namespace \
--set controller.tag=v0.8.3 \
--set speaker.tag=v0.8.3 \
--set configmap.ipRange=192.168.1.11-192.168.1.29
```

저 변수들이 무엇인지 확인하기 위해 차트를 설치하면 `values.yaml` 파일을 까보면 아래와 같이 구성되어 있습니다.

```yaml
controller:
  image: metallb/controller
  tag: v0.8.3

speaker:
  image: metallb/speaker
  tag: v0.8.3

configmap:
  ipRange: 192.168.1.11-192.168.1.13
```

위에 정의된 값들을 --set 인자로 치환해서 phase 별로 쉽게 적용이 가능합니다.


