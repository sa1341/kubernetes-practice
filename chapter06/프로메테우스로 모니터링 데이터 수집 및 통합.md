# 프로메테우스로 모니터링 데이터 수집과 및 통합하기

프로메테우스는 많은 종류의 오브젝트를 설치합니다. 오브젝트를 통해 설치된 요소로 모니터링에 필요한 데이터를 수집하고 저장합니다.

## 1. 프로메테우스 구성요소 살펴보기

프로메테우스로 모니터링 데이터를 수집하고 통합하기 위해 필요한 요소들을 하나씩 살펴봤습니다.

- 프로메테우스 서버: 프로메테우기스의 주요 기능을 수행하는 요소로, 3가지 역할을 맡고 있습니다. 노드 익스포터 외 여러 대상에서 공개된 메트릭을 수집해오는 수집기, 수집한 시계열 메트릭스 데이터를 저장하는 시계열 데이터 베이스, 저장된 데이터를 질의하거나 수집 대상의 상태를 확인할 수 있는 웹 UI 입니다.
프로메테우스의 수집기는 `서비스 디스커버리`라는 방법으로 수집 대상을 찾습니다.

- 노드 익스포터: 노드의 시스템 메트릭 정보를 `HTTP`로 공개하는 역할을 합니다. 설치된 노드에서 특정 파일들을 읽고, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환한 후에 노드 익스포터에서 HTTP 서버로 공개합니다. 공개된 내용을 프로메테우스 서버에서 수집하게 됩니다. 

- 쿠버 스테이트 메트릭(kube-state-metrics): API 서버로 쿠버네티스 클러스터의 여러 메트릭 데이터를 수집한 후, 이를 프로메테우스 서버가 수집할 수 있는 메트릭 데이터로 변환해 공개하는 역할을 합니다. 프로메테우스가 쿠버네티스 클러스터의 여러 정보를 손쉽게 획득할 수 있는 것은 모두 `쿠버 스테이트 메트릭` 덕분입니다.

- 얼럿 매니저: 얼럿매니저는 프로메테우스에 정보 규칙을 설정하고, 정보 이벤트가 발생하면 설정된 정보 메시지를 대상에게 전달하는 기능을 제공합니다. 프로메테우스에 설치하면 프로메테우스 서버에서 주기적으로 경보를 보낼 대상을 감시해 시스템을 안정적으로 운영할 수 있게 합니다.

- 푸시게이트웨이: 배치와 스케줄 작업 시 수행되는 일회성 작업들의 상태를 저장하고 모아서 프로메테우스가 주기적으로 가져갈 수 있도록 공개합니다. 일반적으로 짧은 시간동안 실행되고 종료되는 배치성 프로그램의 메트릭을 저장하거나 외부망에서 접근할 수 없는 내부 시스템의 메트릭을 프록시 형태로 제공하는 용도로 사용합니다.



## 2. 헬름으로 프로메테우스 설치

헬름을 통해서 프로메테우스 차트를 설치하였습니다.

```bash
~/_Book_k8sInfra/ch6/6.2.1/prometheus-server-preconfig.sh # NFS 디렉터리 생성 및 PV, PVC 오브젝트 생성

~/_Book_k8sInfra/ch6/6.2.1/prometheus-install.sh # 프로메테우스 구성요소 설치(큐브 스테이트 메트릭, 프로메테우스 서버, 노드 익스포터 등)
```

프로메테우스 차트가 정상적으로 릴리즈 됐는지 확인하기 위해서 아래와 같은 명령어를 입력합니다.

```bash
kubectl get pods --selector=app=prometheus
```

![image](https://user-images.githubusercontent.com/22395934/235339003-566057ba-d11f-49ee-a554-cb2c8fcae5f1.png)

MetalLB를 통해서 프로메테우스 서버에서 제공하는 `웹 UI`로 접속할 수 있는지 확인해봅니다.

![image](https://user-images.githubusercontent.com/22395934/235339054-4c91c48f-7384-4ef3-88d4-690acf799a98.png)

짜잔.. 정상적으로 동작하는지 확인이 돼었습니다.

## 3. 서비스 디스커버리로 수집 대상 가져오기

이제 프로메테우스에서 수집 대상을 자동으로 인식하고 필요한 정보를 수집합니다. 프로메테우스 서버가 수집 대상을 가져오는 방식은 서비스 디스커버리 덕분입니다. 서비스 디스커버리는 아래와 같은 순서로 동작합니다.

1. 프로메테우스 서버는 컨피그맵에 기록된 내용을 바탕으로 대상을 읽어옵니다. 

2. 읽어온 대상에 대한 메트릭을 가져오기 위해 API 서버에 정보를 요청합니다. 

3. 요청을 통해 알아온 경로로 메트릭 데이터를 수집합니다.

위와 같은 순서로 프로메테우스 서버와 API 서버가 주기적으로 데이터를 주고 받아 수집 대상을 업데이트 하고, 수집 대상에서 공개되는 메트릭을 자동으로 수집합니다.

## 4. 멀티 컨테이너 패턴

파드 내부에 컨테이너 여러 개를 구성하는 방법은 몇 가지 있습니다.

- 사이드카(Sidecar): 메인 컨테이너의 기능을 확장하거나 향상하고자 할때 추가하는 패턴입니다.

- 앰배서더(Ambassador): 사용자가 외부에서 접근할 때 앰배서더 컨테이너를 통해 통신이 이루어지는 형태로, 세부적인 외부 접근 대상이나 방법은 앰배서더 컨테이너에 위임합니다. 주로 프록시 컨테이너를 구성해 외부의 접근을 제어하고 내부 자원을 보호하는 구성이 앰배서더 패턴에 속합니다.

- 어댑터(Adapter): 메인 컨테이너의 정보를 외부에서 사용할 수 있는 형식으로 변환하는 컨테이너가 추가된 형태입니다. 

이렇듯 멀티 컨테이너 패턴은 한 가지 형태로 고정된 것이 아니라 형태를 해석하는 방식에 따라 한 가지 이상으로 부를 수 있습니다. 

### 4.1 사이드 카 패턴

![멀티컨테인_사이드카_패턴](https://user-images.githubusercontent.com/22395934/235341362-fb4b2ead-48f4-4c31-83d0-2df52b1bf3dc.png)

회사에서도 실제로 사이드 카 패턴을 사용하고 있어서 정리해봤습니다.